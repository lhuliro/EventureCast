<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <title>EventureCast - Events & Weather in Hamburg</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}">
    <style>
        .lang-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
            position: absolute;
            right: 30px;
            top: 30px;
        }
        .lang-switcher a {
            display: inline-block;
            border: 2px solid #eee;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            overflow: hidden;
            transition: border 0.2s;
        }
        .lang-switcher a.selected, .lang-switcher a:hover {
            border: 2px solid #3498db;
        }
        .lang-switcher img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="top-container">
        <header style="position:relative;">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="EventureCast Logo">
            <div class="lang-switcher">
                <a href="?lang=de" class="{% if lang == 'de' %}selected{% endif %}" title="Deutsch">
                    <img src="https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/de.svg" alt="Deutsch" />
                </a>
                <a href="?lang=en" class="{% if lang == 'en' %}selected{% endif %}" title="English">
                    <img src="https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/gb.svg" alt="English" />
                </a>
            </div>
        </header>


        <form method="GET">
            <label for="date">{{ t['date'] }}:</label>
            <input type="date" id="date" name="date" value="{{ date_filter }}">

            <label for="time_of_day">{{ t['time_of_day'] }}:</label>
            <select id="time_of_day" name="time_of_day">
                <option value="">-- {{ t['time_of_day'] }} --</option>
                <option value="morning" {% if time_filter == 'morning' %}selected{% endif %}>{{ t['time_morning'] }}</option>
                <option value="afternoon" {% if time_filter == 'afternoon' %}selected{% endif %}>{{ t['time_afternoon'] }}</option>
                <option value="evening" {% if time_filter == 'evening' %}selected{% endif %}>{{ t['time_evening'] }}</option>
            </select>

            <label for="category">{{ t['category'] }}:</label>
            <select id="category" name="category">
                <option value="">{{ t['category_select'] }}</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>

            <label for="venue">{{ t['venue'] }}:</label>
            <input type="text" id="venue" name="venue" value="{{ venue_filter }}">

            <button type="submit" title="{{ t['filter'] }}">{{ t['filter'] }}</button>

            {% if events %}
            <span class="event-counter">{{ events | length }} {{ t['events_found'] }}</span>
            {% endif %}
        </form>
    </div>

    <main>
        <h1>{{ t['upcoming_events'] }}</h1>
        <!-- Map Container -->
        <div id="event-map"></div>

        {% if events %}
        <div class="events-grid">
            {% for event in events %}
            <div class="event-card" title="{{ event.title }}">
                <img src="{{ event.image if event.image else url_for('static', filename='placeholder.png') }}"
                     alt="{{ event.title }}"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='placeholder.png')}}';">
                <div class="event-info">
                    <h3 title="{{ event.title }}">{{ event.title }}</h3>
                    <p>{{ event.start_date }} - {{ event.end_date }}</p>
                    <p>{{ event.time if event.time else t['time_not_specified'] }}</p>
                    <p>
                        {{ event.venue }}
                        {% if event.venue %}
                        <a href="https://www.google.com/maps/search/?api=1&query={{ event.venue | urlencode }}+Hamburg" target="_blank" style="margin-left:5px; font-size:1.1em; text-decoration:none;" title="{{ t['open_gmaps'] }}">üìç</a>
                        {% endif %}
                    </p>
                    <p>{{ t['category'] }}: {{ event.category }}</p>
                    {% if event.weather_icon or event.weather_temp is not none %}
                    <p>{{ t['weather'] }}: {{ event.weather_icon }} {{ event.weather_temp }}¬∞C</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>{{ t['no_events'] }}</p>
        {% endif %}
    </main>

    <!-- Leaflet JS -->
    <script src="{{ url_for('static', filename='leaflet.js') }}"></script>

    <!-- Map Script -->
    <script>
        setTimeout(function() {
            try {
                console.log('üó∫Ô∏è Starting map initialization...');
                const events = {{ events|tojson }};
                const lang = '{{ lang }}';
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    console.error('‚ùå Leaflet library not loaded');
                    document.getElementById('event-map').innerHTML = '<div style="text-align: center; padding: 40px; color: red; font-size: 18px;">‚ùå Map library failed to load</div>';
                    return;
                }
                
                // Check if the map container exists
                const mapContainer = document.getElementById('event-map');
                if (!mapContainer) {
                    console.error('‚ùå Map container not found');
                    return;
                }
                
                console.log('üó∫Ô∏è Creating Leaflet map...');
                
                // Center map on first event if available, else default to Hamburg
                let mapCenter = [53.5511, 9.9937];
                if (events.length > 0 && events[0].lat && events[0].lon) {
                    mapCenter = [events[0].lat, events[0].lon];
                }
                const map = L.map('event-map', {
                    center: mapCenter,
                    zoom: 12,
                    scrollWheelZoom: true
                });
                
                console.log('üåç Adding tile layer...');
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('üìç Adding event markers...');
                
                // Add markers for events
                let markerCount = 0;
                events.forEach(function(event, index) {
                    if (event.lat && event.lon) {
                        try {
                            const marker = L.marker([event.lat, event.lon]).addTo(map);
                            let popupHtml = `
                                <strong>${event.title}</strong><br>
                                <em>${event.venue}</em><br>
                                üìÖ ${event.start_date}<br>
                                üïê ${event.time || 'Time not specified'}<br>
                            `;
                            if (event.venue) {
                                popupHtml += `<a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.venue + ' Hamburg')}' target='_blank' style='color:#007bff;text-decoration:underline;'>Open in Google Maps</a>`;
                            }
                            marker.bindPopup(popupHtml);
                            markerCount++;
                        } catch (markerError) {
                            console.error('Error adding marker for event', index, markerError);
                        }
                    }
                });
                
                console.log(`‚úÖ Map initialized successfully with ${markerCount} markers`);
                
                // Hide the loading message
                mapContainer.classList.add('map-loaded');
                
                // Force map to resize after initialization
                setTimeout(function() {
                    map.invalidateSize();
                    console.log('üîÑ Map size invalidated');
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error initializing map:', error);
                document.getElementById('event-map').innerHTML = '<div style="text-align: center; padding: 40px; color: red; font-size: 16px;">‚ùå Map Error: ' + error.message + '</div>';
            }
        }, 2000); // Wait 2 seconds to ensure everything is loaded

        // Add clear filters button logic
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.id = 'clear-filters';
        clearBtn.textContent = '{{ t['clear_filters'] }}';
        clearBtn.style.marginLeft = '10px';
        clearBtn.style.background = '#e74c3c';
        clearBtn.style.color = 'white';
        clearBtn.style.border = 'none';
        clearBtn.style.padding = '10px 20px';
        clearBtn.style.borderRadius = '5px';
        clearBtn.style.cursor = 'pointer';
        document.querySelector('form').appendChild(clearBtn);
        clearBtn.onclick = function() {
            document.getElementById('date').value = '';
            document.getElementById('time_of_day').selectedIndex = 0;
            document.getElementById('category').selectedIndex = 0;
            document.getElementById('venue').value = '';
            document.querySelector('form').submit();
        };
    </script>
</body>
</html>
