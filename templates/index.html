<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <title>EventureCast - Events & Weather in Hamburg</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}">
    <style>
        .lang-switcher {
            display: flex;
            gap: 10px;
            align-items: center;
            position: absolute;
            right: 30px;
            top: 30px;
        }
        .lang-switcher a {
            display: inline-block;
            border: 2px solid #eee;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            overflow: hidden;
            transition: border 0.2s;
        }
        .lang-switcher a.selected, .lang-switcher a:hover {
            border: 2px solid #3498db;
        }
        .lang-switcher img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="top-container">
        <header style="position:relative;">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="EventureCast Logo">
            <div class="lang-switcher">
                <a href="{{ lang_switcher_de_url }}" class="{% if lang == 'de' %}selected{% endif %}" title="Deutsch">
                    <img src="https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/de.svg" alt="Deutsch" />
                </a>
                <a href="{{ lang_switcher_en_url }}" class="{% if lang == 'en' %}selected{% endif %}" title="English">
                    <img src="https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/gb.svg" alt="English" />
                </a>
            </div>
        </header>


        <form method="GET">
            <label for="date">{{ t['date'] }}:</label>
            <input type="date" id="date" name="date" value="{{ date_filter }}">

            <label for="time_of_day">{{ t['time_of_day'] }}:</label>
            <select id="time_of_day" name="time_of_day">
                <option value="">-- {{ t['time_of_day'] }} --</option>
                <option value="morning" {% if time_filter == 'morning' %}selected{% endif %}>{{ t['time_morning'] }}</option>
                <option value="afternoon" {% if time_filter == 'afternoon' %}selected{% endif %}>{{ t['time_afternoon'] }}</option>
                <option value="evening" {% if time_filter == 'evening' %}selected{% endif %}>{{ t['time_evening'] }}</option>
            </select>

            <label for="category">{{ t['category'] }}:</label>
            <select id="category" name="category">
                <option value="">{{ t['category_select'] }}</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>

            <label for="venue">{{ t['venue'] }}:</label>
            <input type="text" id="venue" name="venue" value="{{ venue_filter }}">

            <button type="submit" title="{{ t['filter'] }}">{{ t['filter'] }}</button>

            {% if events %}
            <span class="event-counter">{{ total_events }} {{ t['events_found'] }}</span>
            {% endif %}
        </form>
    </div>

    <main>
        <h1>{{ t['upcoming_events'] }}</h1>
        <!-- Map Container -->
        <div id="event-map"></div>

        {% if events %}
        <div class="events-grid">
            {% for event in events %}
            <div class="event-card" title="{{ event.title }}">
                <img src="{{ event.image if event.image else url_for('static', filename='placeholder.png') }}"
                     alt="{{ event.title }}"
                     loading="lazy"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='placeholder.png')}}';">
                <div class="event-info">
                    <h3 title="{{ event.title }}">{{ event.title }}</h3>
                    <p>{{ event.start_date }} - {{ event.end_date }}</p>
                    <p>{{ event.time if event.time else t['time_not_specified'] }}</p>
                    <p>
                        {{ event.venue }}
                        {% if event.venue %}
                        <a href="https://www.google.com/maps/search/?api=1&query={{ event.venue | urlencode }}+Hamburg" target="_blank" style="margin-left:5px; font-size:1.1em; text-decoration:none;" title="{{ t['open_gmaps'] }}">üìç</a>
                        {% endif %}
                    </p>
                    <p>{{ t['category'] }}: {{ event.category }}</p>
                    {% if event.weather_icon or event.weather_temp is not none %}
                    <p>{{ t['weather'] }}: {{ event.weather_icon }} {{ event.weather_temp }}¬∞C</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Pagination -->
        <div class="pagination" style="text-align:center; margin: 30px 0;">
            {% if total_pages > 1 %}
                {% for p in range(1, total_pages+1) %}
                    {% if p == page %}
                        <span style="font-weight:bold; color:#3498db; padding:6px 12px;">{{ p }}</span>
                    {% else %}
                        <a href="{{ page_url(p) }}" style="padding:6px 12px; text-decoration:none; color:#333;">{{ p }}</a>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        {% else %}
        <p>{{ t['no_events'] }}</p>
        {% endif %}
    </main>

    {% if events %}
    <!-- Leaflet JS (deferred) -->
    <script src="{{ url_for('static', filename='leaflet.js') }}" defer></script>
    <script defer>
    window.addEventListener('DOMContentLoaded', function() {
        if (!window.L) return;
        const events = {{ events|tojson }};
        if (!events.length) return;
        const mapContainer = document.getElementById('event-map');
        let mapCenter = [53.5511, 9.9937];
        if (events[0].lat && events[0].lon) mapCenter = [events[0].lat, events[0].lon];
        const map = L.map('event-map', { center: mapCenter, zoom: 12, scrollWheelZoom: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        events.forEach(function(event) {
            if (event.lat && event.lon) {
                const marker = L.marker([event.lat, event.lon]).addTo(map);
                let popupHtml = `<strong>${event.title}</strong><br><em>${event.venue}</em><br>üìÖ ${event.start_date}<br>üïê ${event.time || 'Time not specified'}<br>`;
                if (event.venue) popupHtml += `<a href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.venue + ' Hamburg')}' target='_blank' style='color:#007bff;text-decoration:underline;'>Open in Google Maps</a>`;
                marker.bindPopup(popupHtml);
            }
        });
        setTimeout(function() { map.invalidateSize(); }, 500);
    });
    </script>
    {% endif %}
    <script>
    // Add clear filters button logic
    window.addEventListener('DOMContentLoaded', function() {
        const clearBtn = document.createElement('button');
        clearBtn.type = 'button';
        clearBtn.id = 'clear-filters';
        clearBtn.textContent = '{{ t['clear_filters'] }}';
        clearBtn.style.marginLeft = '10px';
        clearBtn.style.background = '#e74c3c';
        clearBtn.style.color = 'white';
        clearBtn.style.border = 'none';
        clearBtn.style.padding = '10px 20px';
        clearBtn.style.borderRadius = '5px';
        clearBtn.style.cursor = 'pointer';
        document.querySelector('form').appendChild(clearBtn);
        clearBtn.onclick = function() {
            document.getElementById('date').value = '';
            document.getElementById('time_of_day').selectedIndex = 0;
            document.getElementById('category').selectedIndex = 0;
            document.getElementById('venue').value = '';
            document.querySelector('form').submit();
        };
    });
    </script>
</body>
</html>
